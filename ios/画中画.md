# ç”»ä¸­ç”»
ç”»ä¸­ç”»æ˜¯ iOS14 æ¨å‡ºçš„åŠŸèƒ½ï¼Œä¸€ç§æ§åˆ¶å™¨ï¼Œç”¨äºåœ¨æµ®åŠ¨çš„å¯è°ƒæ•´å¤§å°çš„çª—å£ä¸­å“åº”ç”¨æˆ·å¯åŠ¨çš„ç”»ä¸­ç”»è§†é¢‘æ’­æ”¾ã€‚Bæ ˆçš„è§†é¢‘å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚

>ç”»ä¸­ç”»æ˜¯Appleå¸Œæœ›å§‹ç»ˆåœ¨ç”¨æˆ·æ§åˆ¶ä¸‹çš„ä¸€é¡¹ç”¨æˆ·åŠŸèƒ½ã€‚ä»…åœ¨å“åº”ç”¨æˆ·çš„æ˜ç¡®è¯·æ±‚æ—¶æ‰è°ƒç”¨PiPã€‚å¦‚æœæŸä¸ªåº”ç”¨ä»¥éç”¨æˆ·ç›´æ¥æŒ‡å¯¼çš„æ–¹å¼è°ƒç”¨PiPï¼Œåˆ™App Storeå®¡æ ¸å°ç»„å°†æ‹’ç»å®ƒã€‚

å¦‚æœä½¿ç”¨ç”»ä¸­ç”»éœ€è¦Xcodeè®¾ç½®æ‰“å…è®¸åå°æ’­æ”¾ `Audio, AirPlay, and Picture in Picture`
![](./imgs/ios_img_67.jpg)

## ç›¸å…³API
ç”»ä¸­ç”»åŠŸèƒ½éœ€è¦ä½¿ç”¨åˆ°`AVPictureInPictureController`ç±»ï¼Œç›¸å…³çš„API:

```objc
// å½“å‰è®¾å¤‡æ˜¯å¦æ”¯æŒç”»ä¸­ç”»
+ (BOOL)isPictureInPictureSupported;
// åˆ›å»ºç”»ä¸­ç”»æ§åˆ¶å™¨
- (nullable instancetype)initWithPlayerLayer:(AVPlayerLayer *)playerLayer NS_DESIGNATED_INITIALIZER;
// è¦æ’­æ”¾åª’ä½“çš„æ’­æ”¾å™¨å±‚
@property (nonatomic, readonly) AVPlayerLayer *playerLayer;
// æ˜¯å¦å…è®¸ç”¨æˆ·è·³è¿‡åª’ä½“å†…å®¹
@property (nonatomic) BOOL requiresLinearPlayback API_AVAILABLE(ios(14.0), macos(11.0), tvos(14.0)) API_UNAVAILABLE(watchos);
// å§”æ‰˜å¯¹è±¡
@property (nonatomic, weak, nullable) id <AVPictureInPictureControllerDelegate> delegate;
// å½“å‰æ˜¯å¦å¯ä»¥è¿›è¡Œç”»ä¸­ç”»å›æ”¾
@property (nonatomic, readonly, getter = isPictureInPicturePossible) BOOL pictureInPicturePossible;
// æ§åˆ¶å™¨çš„ç”»ä¸­ç”»çª—å£æ˜¯å¦åœ¨å±å¹•ä¸Š
@property (nonatomic, readonly, getter = isPictureInPictureActive) BOOL pictureInPictureActive;
// ç³»ç»Ÿæ˜¯å¦æŒ‚èµ·æ§åˆ¶å™¨çš„ç”»ä¸­ç”»çª—å£
@property (nonatomic, readonly, getter = isPictureInPictureSuspended) BOOL pictureInPictureSuspended;

// å¼€å§‹æ’­æ”¾
- (void)startPictureInPicture;
// åœæ­¢æ’­æ”¾(å¦‚æœå½“å‰å¤„äºæ´»è·ƒçŠ¶æ€)
- (void)stopPictureInPicture;
// æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€å¹¶ä¸”å¯ä»¥å…³é—­
@property (nonatomic, readonly) BOOL canStopPictureInPicture API_AVAILABLE(tvos(14.0)) API_UNAVAILABLE(ios, macos, watchos);

// ç³»ç»Ÿé»˜è®¤çš„â€œç”»ä¸­ç”»â€å¼€å§‹æ¨¡æ¿å›¾åƒï¼Œç”¨äºåº”ç”¨ç¨‹åºçš„â€œç”»ä¸­ç”»â€æŒ‰é’®ã€‚
@property (class, nonatomic, readonly) UIImage *pictureInPictureButtonStartImage API_AVAILABLE(ios(13.0), tvos(14.0));
// ç³»ç»Ÿé»˜è®¤çš„ç”»ä¸­ç”»åœæ­¢æ¨¡æ¿å›¾åƒï¼Œç”¨äºåº”ç”¨ç¨‹åºçš„ç”»ä¸­ç”»æŒ‰é’®ã€‚
@property (class, nonatomic, readonly) UIImage *pictureInPictureButtonStopImage API_AVAILABLE(ios(13.0), tvos(14.0));

// å‘Šè¯‰å§”æ‰˜äººç”»ä¸­ç”»å³å°†åœæ­¢çš„æ—¶é—´ï¼Œä½¿æ‚¨çš„åº”ç”¨æœ‰æœºä¼šæ¢å¤å…¶è§†é¢‘æ’­æ”¾ç”¨æˆ·ç•Œé¢ã€‚
- (void)pictureInPictureController:(AVPictureInPictureController *)pictureInPictureController restoreUserInterfaceForPictureInPictureStopWithCompletionHandler:(void (^)(BOOL restored))completionHandler;
// å½“ç”»ä¸­ç”»å³å°†å¼€å§‹æ—¶
- (void)pictureInPictureControllerWillStartPictureInPicture:(AVPictureInPictureController *)pictureInPictureController;
// è¯¥ç”»ä¸­ç”»å›æ”¾å·²ç»å¼€å§‹
- (void)pictureInPictureControllerDidStartPictureInPicture:(AVPictureInPictureController *)pictureInPictureController;
// ç”»ä¸­ç”»æ— æ³•å¯åŠ¨
- (void)pictureInPictureController:(AVPictureInPictureController *)pictureInPictureController failedToStartPictureInPictureWithError:(NSError *)error;
// ç”»ä¸­ç”»å³å°†åœæ­¢
- (void)pictureInPictureControllerWillStopPictureInPicture:(AVPictureInPictureController *)pictureInPictureController;
// ç”»ä¸­ç”»åœæ­¢
- (void)pictureInPictureControllerDidStopPictureInPicture:(AVPictureInPictureController *)pictureInPictureController;
```

> ğŸº æ³¨æ„ï¼šä½¿ç”¨ç”»ä¸­ç”»éœ€è¦åœ¨æ§åˆ¶å™¨ä¸­è®¾ç½®å…è®¸åå°æ’­æ”¾
```objc
// å…è®¸åå°æ’­æ”¾
[[AVAudioSession sharedInstance] setCategory:AVAudioSessionCategoryPlayback error:nil];
[[AVAudioSession sharedInstance] setActive:YES error:nil];
```

## å®Œæ•´çš„ä¾‹å­ğŸŒ°

ç”±äº `AVPictureInPictureController` åªèƒ½ä½¿ç”¨ `AVPlayer` è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œ `AVPlayer` è§£ç çš„è§†é¢‘æ ¼å¼æœ‰é™ï¼Œç›®å‰æµ‹è¯•çš„MP4å’Œm3u8æ ¼å¼å¯ä»¥æ’­æ”¾ï¼ŒFLVæ ¼å¼ä¸èƒ½æ’­æ”¾ã€‚[ç‚¹å‡»ä¸‹è½½Demo](https://e.coding.net/mlean/iosdemo/PictureInPictureDemo.git)

```objc
#import "ViewController.h"
#import <AVKit/AVKit.h>

@interface ViewController ()<AVPictureInPictureControllerDelegate>
@property (weak, nonatomic) IBOutlet UIButton *startBtn;
@property (weak, nonatomic) IBOutlet UIButton *endBtn;
@property (weak, nonatomic) IBOutlet UIView *playerView;

@property(nonatomic,strong) AVPictureInPictureController * picController;
@property(nonatomic,strong) AVPlayer * player;
@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    // å…è®¸åå°æ’­æ”¾
    [[AVAudioSession sharedInstance] setCategory:AVAudioSessionCategoryPlayback error:nil];
    [[AVAudioSession sharedInstance] setActive:YES error:nil];
    
    // è·å–ç”»ä¸­ç”»çš„å›¾ç‰‡
    UIImage * startImage = [AVPictureInPictureController pictureInPictureButtonStartImageCompatibleWithTraitCollection:nil];
    UIImage * endImage = [AVPictureInPictureController pictureInPictureButtonStopImageCompatibleWithTraitCollection:nil];
    
    // è®¾ç½®å›¾ç‰‡
    [_startBtn setImage:[startImage imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal] forState:UIControlStateNormal];
    [_endBtn setImage:endImage forState:UIControlStateNormal];
}

-(void)viewDidAppear:(BOOL)animated
{
    [super viewDidAppear:animated];
    [self setUpPlayer];
}

- (void)setUpPlayer{
    NSString * path = [[NSBundle mainBundle] pathForResource:@"test_video" ofType:@"mp4"];
    
    // æ”¯æŒæœ¬åœ°MP4 æ–‡ä»¶
    // æ”¯æŒ m3u8 æ ¼å¼  http://devimages.apple.com/iphone/samples/bipbop/bipbopall.m3u8
    // æ”¯æŒ MP4 æ ¼å¼ https://media.w3.org/2010/05/sintel/trailer.mp4
    AVPlayerItem * item = [[AVPlayerItem alloc] initWithURL:[NSURL fileURLWithPath:path]];
    
    self.player = [AVPlayer playerWithPlayerItem:item];
    AVPlayerLayer * layer = [AVPlayerLayer playerLayerWithPlayer:self.player];
    layer.frame = self.playerView.bounds;
    layer.backgroundColor = [UIColor blueColor].CGColor;
    NSLog(@"%@",NSStringFromCGRect(self.view.bounds));
    [self.playerView.layer addSublayer:layer];

    NSLog(@"---------------%@",NSStringFromCGRect(layer.bounds));

    self.picController = [[AVPictureInPictureController alloc] initWithPlayerLayer:layer];
    self.picController.delegate = self;
    [self.player play];
}

// è¿›å…¥ç”»ä¸­ç”»
- (IBAction)startInPictureBtn:(id)sender {
    NSLog(@"-----> ç‚¹å‡»è¿›å…¥ç”»ä¸­ç”»");
    
    // å¦‚æœæœ‰æƒé™
    if (self.picController.isPictureInPicturePossible) {
        [self.picController startPictureInPicture];
    }else{
        NSLog(@"æ²¡æœ‰ç›¸å…³æƒé™æˆ–è€…ç³»ç»Ÿä¸æ”¯æŒ,ä¸èƒ½è¿›å…¥ç”»ä¸­ç”»");
    }
}

// ç»“æŸç”»ä¸­ç”»
- (IBAction)endInPictureBtn:(id)sender {
    NSLog(@"-----> ç‚¹å‡»é€€å‡ºç”»ä¸­ç”»");
    
    [self.picController stopPictureInPicture];
}

#pragma mark - delegate
- (void)pictureInPictureControllerWillStartPictureInPicture:(AVPictureInPictureController *)pictureInPictureController{
    
}

- (void)pictureInPictureControllerDidStartPictureInPicture:(AVPictureInPictureController *)pictureInPictureController{
    
}

- (void)pictureInPictureController:(AVPictureInPictureController *)pictureInPictureController failedToStartPictureInPictureWithError:(NSError *)error{
    NSLog(@"%@",error);
}

- (void)pictureInPictureControllerWillStopPictureInPicture:(AVPictureInPictureController *)pictureInPictureController{
    
}

- (void)pictureInPictureControllerDidStopPictureInPicture:(AVPictureInPictureController *)pictureInPictureController{
    
}

- (void)pictureInPictureController:(AVPictureInPictureController *)pictureInPictureController restoreUserInterfaceForPictureInPictureStopWithCompletionHandler:(void (^)(BOOL restored))completionHandler{
    
}

@end
```

## æ¨èç½‘å€
* [iOSå¼€å‘-iOS14ç”»ä¸­ç”»(OC)](https://www.jianshu.com/p/d579f09993e8)